#!/bin/bash
{{- $role := index . "role" | default "desktop" }}

# =============================================================================
# CLI & TUI Tools Installation Script
# =============================================================================
#
# Description:
#   Installs modern CLI and TUI tools across different operating systems
#   (Arch, Fedora, Debian/Ubuntu, macOS). Prioritizes pre-built binaries
#   over cargo/source builds for faster, more reliable installations.
#
# Installation Strategy:
#   1. Native package manager packages (pacman, dnf, apt, brew)
#   2. Official pre-built binaries from GitHub releases
#   3. Upstream installation scripts (when available)
#   4. Cargo builds (only as last resort for tools without binaries)
#
# Version History:
# -----------------------------------------------------------------------------
# 2025-12-20: Major refactoring to minimize cargo dependencies
#   - Replaced most cargo installations with native packages and pre-built binaries
#   - Arch: Added fresh-editor-bin AUR package, removed cargo fallback
#   - Fedora: Added binary downloads for lazygit, lazydocker, yazi, gdu
#   - Fedora: Cargo only used for dog/bluetui on desktop/laptop roles
#   - Debian: Added binary downloads for yazi, bottom, gdu
#   - Debian: Removed desktop-specific tools (bluetui, dog) - server-focused
#   - Debian: Cargo only as fallback for procs, bandwhich, yazi if binaries fail
#   - Result: Faster installs, fewer build failures, minimal Rust toolchain dependency
#
# =============================================================================

set -euo pipefail

# Handle sudo when running as root
sudo() {
    if [ "$EUID" -eq 0 ]; then
        "$@"
    else
        command sudo "$@"
    fi
}

echo "=== Installing CLI & TUI Tools ==="
echo "Role: {{ $role }}"
echo "OS: $(uname -s)"
echo ""

# Detect OS and package manager
detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [[ -f /etc/arch-release ]]; then
        echo "arch"
    elif [[ -f /etc/fedora-release ]]; then
        echo "fedora"
    elif [[ -f /etc/debian_version ]]; then
        echo "debian"
    else
        echo "unknown"
    fi
}

OS_TYPE=$(detect_os)

ensure_rust_and_cargo() {
    if command -v cargo &> /dev/null; then
        echo "cargo already installed"
        return
    fi

    echo ""
    echo "Installing Rust toolchain (rustup + cargo)..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

    # Source the cargo env for this script
    export PATH="$HOME/.cargo/bin:$PATH"

    # Add to shell configs if not already present
    for rc_file in "$HOME/.bashrc" "$HOME/.zshrc"; do
        if [[ -f "$rc_file" ]] && ! grep -q 'cargo/env' "$rc_file"; then
            echo "" >> "$rc_file"
            echo '# Rust cargo path' >> "$rc_file"
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$rc_file"
            echo "  âœ“ Added cargo to PATH in $(basename $rc_file)"
        fi
    done

    if ! command -v cargo &> /dev/null; then
        echo "âŒ Failed to install cargo (Rust toolchain)"
        return 1
    fi

    echo "âœ“ Rust toolchain installed"
}

cargo_install_if_missing() {
    local crate="$1"
    local bin_name="${2:-$1}"

    if command -v "$bin_name" &> /dev/null; then
        echo "  - $bin_name already installed, skipping"
        return
    fi

    echo "  - Installing $bin_name via cargo ($crate)..."
    if cargo install "$crate" &> /dev/null; then
        echo "    âœ“ $bin_name installed"
    else
        echo "    âš  Failed to install $bin_name"
    fi
}

# Installs the latest stable version of micro via the official upstream binary script
install_micro_binary() {
    local existing_micro=""
    if command -v micro &> /dev/null; then
        existing_micro=$(which micro)
        local micro_version=$(micro --version 2>/dev/null | head -n1)
        echo "  - Found existing micro at: $existing_micro"
        echo "    Version: $micro_version"

        # Skip if it's already a working version (not the broken dev build)
        if [[ "$micro_version" != *"-dev"* ]]; then
            echo "    âœ“ micro version is good, skipping installation"
            
            # Quick speed test
            local start=$(date +%s%3N)
            timeout 5s micro --version &>/dev/null
            local duration=$(($(date +%s%3N) - start))
            
            if [[ $duration -gt 3000 ]]; then
                echo "    âš  Warning: micro seems slow (${duration}ms startup)"
            else
                echo "    âœ“ micro is responsive (${duration}ms startup)"
            fi
            return 0
        fi

        # Remove Arch package if it's the broken dev build
        if [[ "$micro_version" == *"-dev"* ]]; then
            echo "    Detected broken dev build, removing..."
            
            if command -v pacman &>/dev/null && pacman -Q micro &>/dev/null; then
                sudo pacman -R --noconfirm micro
            elif command -v apt &>/dev/null && dpkg -l | grep -q "^ii.*micro"; then
                sudo apt remove -y micro
            elif command -v dnf &>/dev/null && rpm -q micro &>/dev/null; then
                sudo dnf remove -y micro
            elif [[ -f "$existing_micro" ]]; then
                echo "    Removing $existing_micro manually..."
                sudo rm -f "$existing_micro"
            fi
        fi
    fi

    echo "  - Installing micro via official installer..."
    if curl https://getmic.ro | bash; then
        # Move to system location
        if [[ -f ./micro ]]; then
            sudo mv ./micro /usr/local/bin/micro
            sudo chmod +x /usr/local/bin/micro
        fi
        
        # Verify installation
        if ! command -v micro &> /dev/null; then
            echo "    âŒ micro not found in PATH after installation"
            return 1
        fi
        
        echo "    âœ“ micro installed successfully"
        echo "    Version: $(micro --version 2>/dev/null | head -n1)"

        # Quick speed test
        local start=$(date +%s%3N)
        timeout 5s micro --version &>/dev/null
        local duration=$(($(date +%s%3N) - start))

        if [[ $duration -gt 3000 ]]; then
            echo "    âš  Warning: micro seems slow (${duration}ms startup)"
        else
            echo "    âœ“ micro is responsive (${duration}ms startup)"
        fi
    else
        echo "    âš  Failed to install micro"
        return 1
    fi
}

setup_truecolor_terminfo() {
    # Skip on WSL - Windows Terminal supports truecolor natively
    if grep -qi microsoft /proc/version 2>/dev/null; then
        echo "  - Skipping terminfo setup (WSL detected - Windows Terminal supports truecolor natively)"
        return 0
    fi
    
    echo ""
    echo "Setting up truecolor terminfo support..."
    
    # Check if xterm-direct already has RGB
    if infocmp -x xterm-direct 2>/dev/null | grep -q "RGB"; then
        echo "  - RGB terminfo already configured"
        return 0
    fi
    
    # Create user terminfo directory
    mkdir -p "$HOME/.terminfo"
    
    # Extract and add RGB capability
    if command -v infocmp &>/dev/null && command -v tic &>/dev/null; then
        echo "  - Adding RGB capability to xterm-direct terminfo..."
        infocmp xterm-direct > /tmp/xterm-direct.src 2>/dev/null || {
            echo "    âš  xterm-direct not found in system terminfo (non-fatal)"
            return 0
        }
        
        # Add RGB to capabilities line (line 3)
        sed -i '3s/am,/am, RGB,/' /tmp/xterm-direct.src
        
        # Compile to user terminfo
        tic -x /tmp/xterm-direct.src -o "$HOME/.terminfo" 2>/dev/null || {
            echo "    âš  Failed to compile terminfo (non-fatal)"
            rm -f /tmp/xterm-direct.src
            return 0
        }
        
        # Add TERMINFO export to shell configs
        for rc_file in "$HOME/.bashrc" "$HOME/.zshrc"; do
            if [[ -f "$rc_file" ]] && ! grep -q 'TERMINFO=' "$rc_file"; then
                echo "" >> "$rc_file"
                echo '# User terminfo for truecolor support' >> "$rc_file"
                echo 'export TERMINFO=~/.terminfo' >> "$rc_file"
            fi
        done
        
        echo "    âœ“ RGB terminfo configured"
        rm -f /tmp/xterm-direct.src
    else
        echo "    âš  infocmp/tic not available, skipping terminfo setup (non-fatal)"
        return 0
    fi
}

install_arch() {
    echo "ðŸ“¦ Installing packages for Arch Linux..."

    # Core packages (official repos)
    local core_packages=(
        # Shell enhancements
        fzf zoxide starship

        # Modern CLI replacements
        ripgrep fd bat eza dust duf procs sd

        # File management & navigation
        yazi tree gdu

        # System monitoring
        btop htop bottom nethogs bandwhich

        # Git tools
        lazygit git-delta

        # Text tools
        tldr # Note: 'micro' removed for binary install

        # Archive & media tools (for yazi previews & general use)
        p7zip ffmpeg imagemagick poppler jq

        # Network tools
        curl wget httpie

        # Dev tools
        github-cli tokei hyperfine pyright bash-language-server

        # System utilities
        rsync unzip zip

        # Optional but useful
        fastfetch glow
    )

    echo "Installing core packages..."
    sudo pacman -S --needed --noconfirm "${core_packages[@]}" || {
        echo "âš  Some packages failed to install"
        echo "Continuing with remaining setup..."
    }

    # Install micro via the official binary script
    install_micro_binary

    # AUR packages (require yay or paru)
    local aur_packages=(
        lazydocker
        bluetui
        fresh-editor-bin  # Pre-built binary, avoids cargo build issues
    )

    # Optional AUR packages (may have dependency issues)
    local optional_aur=(
        ueberzugpp
    )

    if command -v yay &> /dev/null; then
        echo ""
        echo "Installing AUR packages via yay..."
        yay -S --needed --noconfirm "${aur_packages[@]}" 2>/dev/null || {
            echo "âš  Some AUR packages failed, continuing..."
        }

        echo ""
        echo "Attempting optional packages..."
        for pkg in "${optional_aur[@]}"; do
            echo "  Trying: $pkg"
            yay -S --needed --noconfirm "$pkg" 2>/dev/null && {
                echo "  âœ“ $pkg installed"
            } || {
                echo "  âš  $pkg skipped (dependency conflicts or unavailable)"
            }
        done

    elif command -v paru &> /dev/null; then
        echo ""
        echo "Installing AUR packages via paru..."
        paru -S --needed --noconfirm "${aur_packages[@]}" 2>/dev/null || {
            echo "âš  Some AUR packages failed, continuing..."
        }

        echo ""
        echo "Attempting optional packages..."
        for pkg in "${optional_aur[@]}"; do
            echo "  Trying: $pkg"
            paru -S --needed --noconfirm "$pkg" 2>/dev/null && {
                echo "  âœ“ $pkg installed"
            } || {
                echo "  âš  $pkg skipped (dependency conflicts or unavailable)"
            }
        done
    else
        echo "âš  No AUR helper (yay/paru) found"
        echo "  Required: ${aur_packages[*]}"
        echo "  Optional: ${optional_aur[*]}"
    fi

    # fresh-editor is now installed via AUR (fresh-editor-bin) above
    # No cargo installation needed - the pre-built binary avoids build failures

    setup_truecolor_terminfo

    echo "âœ“ Arch packages installed"
}

install_fedora() {
    echo "ðŸ“¦ Installing packages for Fedora..."

    local packages=(
        # Core tools available in Fedora repos
        fzf zoxide starship ripgrep fd-find bat eza dust duf procs sd
        tree btop htop nethogs bandwhich git-delta tldr bottom
        p7zip ffmpeg ImageMagick poppler-utils jq curl wget httpie
        gh tokei hyperfine rsync unzip zip glow
    )

    echo "Installing packages..."
    sudo dnf install -y "${packages[@]}"

    # Install micro via the official binary script
    install_micro_binary

    # Setup truecolor support
    setup_truecolor_terminfo

    echo ""
    echo "Installing additional tools via direct binary downloads..."

    # Install lazygit via binary
    if ! command -v lazygit &> /dev/null; then
        echo "  - Installing lazygit via official binary..."
        local lazygit_version="0.45.1"
        local lazygit_url="https://github.com/jesseduffield/lazygit/releases/download/v${lazygit_version}/lazygit_${lazygit_version}_Linux_x86_64.tar.gz"
        if curl -fsSL "$lazygit_url" -o /tmp/lazygit.tar.gz && \
           tar -xzf /tmp/lazygit.tar.gz -C /tmp/ lazygit && \
           sudo mv /tmp/lazygit /usr/local/bin/ && \
           sudo chmod +x /usr/local/bin/lazygit; then
            echo "    âœ“ lazygit installed"
            rm -f /tmp/lazygit.tar.gz
        else
            echo "    âš  Failed to install lazygit"
        fi
    fi

    # Install lazydocker via official script
    if ! command -v lazydocker &> /dev/null; then
        echo "  - Installing lazydocker via upstream script..."
        if DIR="/usr/local/bin" \
          curl -fsSL https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh \
          | bash; then
            echo "    âœ“ lazydocker installed"
        else
            echo "    âš  Failed to install lazydocker"
        fi
    fi

    # Install yazi via binary
    if ! command -v yazi &> /dev/null; then
        echo "  - Installing yazi via official binary..."
        local yazi_version="0.4.2"
        local yazi_url="https://github.com/sxyazi/yazi/releases/download/v${yazi_version}/yazi-x86_64-unknown-linux-gnu.zip"
        if curl -fsSL "$yazi_url" -o /tmp/yazi.zip && \
           unzip -q /tmp/yazi.zip -d /tmp/ && \
           sudo mv /tmp/yazi-x86_64-unknown-linux-gnu/yazi /usr/local/bin/ && \
           sudo chmod +x /usr/local/bin/yazi; then
            echo "    âœ“ yazi installed"
            rm -rf /tmp/yazi.zip /tmp/yazi-x86_64-unknown-linux-gnu
        else
            echo "    âš  Failed to install yazi"
        fi
    fi

    # Install gdu via binary
    if ! command -v gdu &> /dev/null; then
        echo "  - Installing gdu via official binary..."
        local gdu_version="5.29.0"
        local gdu_url="https://github.com/dundee/gdu/releases/download/v${gdu_version}/gdu_linux_amd64.tgz"
        if curl -fsSL "$gdu_url" -o /tmp/gdu.tgz && \
           tar -xzf /tmp/gdu.tgz -C /tmp/ && \
           sudo mv /tmp/gdu_linux_amd64 /usr/local/bin/gdu && \
           sudo chmod +x /usr/local/bin/gdu; then
            echo "    âœ“ gdu installed"
            rm -f /tmp/gdu.tgz
        else
            echo "    âš  Failed to install gdu"
        fi
    fi

    # Only install cargo for remaining tools if needed
    local need_cargo=false
    {{- if or (eq $role "desktop") (eq $role "laptop") }}
    if ! command -v dog &> /dev/null; then
        need_cargo=true
    fi
    if ! command -v bluetui &> /dev/null; then
        need_cargo=true
    fi
    {{- end }}

    if [ "$need_cargo" = true ]; then
        echo ""
        echo "Installing remaining tools via cargo (desktop/laptop only)..."
        if ensure_rust_and_cargo; then
            export PATH="$HOME/.cargo/bin:$PATH"

            {{- if or (eq $role "desktop") (eq $role "laptop") }}
            cargo_install_if_missing dog dog
            cargo_install_if_missing bluetui bluetui
            {{- end }}
        else
            echo "âš  Skipping cargo-based tools (Rust toolchain not available)"
        fi
    else
        echo ""
        echo "âœ“ All tools installed via native packages/binaries - no cargo needed!"
    fi

    echo "âœ“ Fedora packages installed"
}

install_debian() {
    echo "ðŸ“¦ Installing packages for Debian/Ubuntu..."

    sudo apt update

    # Detect Ubuntu version
    UBUNTU_VERSION=$(lsb_release -rs 2>/dev/null || echo "unknown")
    echo "Detected Ubuntu version: $UBUNTU_VERSION"

    if [[ "$UBUNTU_VERSION" == "24.04" ]]; then
        echo "âœ“ Ubuntu 24.04 detected - using optimized package list"
        
        # Ubuntu 24.04 Noble - many modern tools now in repos!
        local packages=(
            # Shell enhancements (now in repos!)
            fzf zoxide
            
            # Modern CLI replacements (now in repos!)
            ripgrep fd-find bat tree eza git-delta gdu
            
            # System monitoring
            btop htop nethogs
            
            # Archive & media tools
            p7zip-full ffmpeg imagemagick poppler-utils jq
            
            # Network tools
            curl wget httpie
            
            # Dev tools
            hyperfine
            
            # System utilities
            rsync unzip zip
            
            # Documentation
            tldr
        )
    else
        echo "âœ“ Ubuntu $UBUNTU_VERSION or Debian - using fallback package list"
        
        local packages=(
            fzf ripgrep fd-find bat tree ncdu
            btop htop nethogs
            p7zip-full ffmpeg imagemagick poppler-utils jq
            curl wget httpie rsync unzip zip
        )
    fi

    echo "Installing packages via apt..."
    sudo apt install -y "${packages[@]}"

    install_micro_binary
    setup_truecolor_terminfo

    echo ""
    echo "ðŸ“¦ Installing GitHub CLI via official repo..."
    
    if ! command -v gh &>/dev/null; then
        echo "Installing GitHub CLI..."
        (type -p wget >/dev/null || sudo apt install wget -y) \
        && sudo mkdir -p -m 755 /etc/apt/keyrings \
        && wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null \
        && sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update \
        && sudo apt install gh -y
    fi

    echo ""
    echo "ðŸ“¦ Installing tools via official scripts..."

    if ! command -v starship &>/dev/null; then
        echo "Installing starship..."
        curl -sS https://starship.rs/install.sh | sh -s -- -y
    fi

    if ! command -v lazydocker &>/dev/null; then
        echo "Installing lazydocker..."
        curl -sSL https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh | bash
    fi

    echo ""
    echo "ðŸ“¦ Installing tools via binary releases..."

    if ! command -v lazygit &>/dev/null; then
        echo "Installing lazygit..."
        LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
        curl -Lo /tmp/lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
        sudo tar xf /tmp/lazygit.tar.gz -C /usr/local/bin lazygit
        rm /tmp/lazygit.tar.gz
    fi

    if ! command -v yazi &>/dev/null; then
        echo "Installing yazi..."
        curl -fsSL "https://github.com/sxyazi/yazi/releases/download/v0.4.2/yazi-x86_64-unknown-linux-gnu.zip" -o /tmp/yazi.zip
        unzip -q /tmp/yazi.zip -d /tmp/
        sudo mv /tmp/yazi-x86_64-unknown-linux-gnu/yazi /usr/local/bin/
        sudo chmod +x /usr/local/bin/yazi
        rm -rf /tmp/yazi.zip /tmp/yazi-x86_64-unknown-linux-gnu
    fi

    if ! command -v btm &>/dev/null; then
        echo "Installing bottom..."
        wget -q "https://github.com/ClementTsang/bottom/releases/download/0.10.2/bottom_0.10.2-1_amd64.deb" -O /tmp/bottom.deb
        sudo dpkg -i /tmp/bottom.deb
        rm /tmp/bottom.deb
    fi

    if ! command -v dust &>/dev/null; then
        echo "Installing dust..."
        wget -q "https://github.com/bootandy/dust/releases/download/v1.1.1/dust-v1.1.1-x86_64-unknown-linux-gnu.tar.gz" -O /tmp/dust.tar.gz
        tar -xzf /tmp/dust.tar.gz -C /tmp/
        sudo mv /tmp/dust-v1.1.1-x86_64-unknown-linux-gnu/dust /usr/local/bin/
        sudo chmod +x /usr/local/bin/dust
        rm -rf /tmp/dust.tar.gz /tmp/dust-v1.1.1-x86_64-unknown-linux-gnu
    fi

    if ! command -v procs &>/dev/null; then
        echo "Installing procs..."
        wget -q "https://github.com/dalance/procs/releases/download/v0.14.8/procs-v0.14.8-x86_64-linux.zip" -O /tmp/procs.zip
        unzip -q /tmp/procs.zip -d /tmp/
        sudo mv /tmp/procs /usr/local/bin/
        sudo chmod +x /usr/local/bin/procs
        rm /tmp/procs.zip
    fi

    if ! command -v sd &>/dev/null; then
        echo "Installing sd..."
        wget -q "https://github.com/chmln/sd/releases/download/v1.0.0/sd-v1.0.0-x86_64-unknown-linux-gnu.tar.gz" -O /tmp/sd.tar.gz
        tar -xzf /tmp/sd.tar.gz -C /tmp/
        sudo mv /tmp/sd-v1.0.0-x86_64-unknown-linux-gnu/sd /usr/local/bin/
        sudo chmod +x /usr/local/bin/sd
        rm -rf /tmp/sd.tar.gz /tmp/sd-v1.0.0-x86_64-unknown-linux-gnu
    fi

    if ! command -v tokei &>/dev/null; then
        echo "Installing tokei..."
        wget -q "https://github.com/XAMPPRocky/tokei/releases/download/v12.1.2/tokei-x86_64-unknown-linux-gnu.tar.gz" -O /tmp/tokei.tar.gz
        tar -xzf /tmp/tokei.tar.gz -C /tmp/
        sudo mv /tmp/tokei /usr/local/bin/
        sudo chmod +x /usr/local/bin/tokei
        rm /tmp/tokei.tar.gz
    fi

    if ! command -v duf &>/dev/null; then
        echo "Installing duf..."
        wget -q "https://github.com/muesli/duf/releases/download/v0.8.1/duf_0.8.1_linux_amd64.deb" -O /tmp/duf.deb
        sudo dpkg -i /tmp/duf.deb
        rm /tmp/duf.deb
    fi

    if ! command -v bandwhich &>/dev/null; then
        echo "Installing bandwhich..."
        wget -q "https://github.com/imsnif/bandwhich/releases/download/v0.23.1/bandwhich-v0.23.1-x86_64-unknown-linux-musl.tar.gz" -O /tmp/bandwhich.tar.gz
        tar -xzf /tmp/bandwhich.tar.gz -C /tmp/
        sudo mv /tmp/bandwhich /usr/local/bin/
        sudo chmod +x /usr/local/bin/bandwhich
        rm /tmp/bandwhich.tar.gz
    fi

	# fastfetch
    if ! command -v fastfetch &>/dev/null; then
        echo "Installing fastfetch..."
        FASTFETCH_VERSION=$(curl -s "https://api.github.com/repos/fastfetch-cli/fastfetch/releases/latest" | grep -Po '"tag_name": "\K[^"]*')
        wget -q "https://github.com/fastfetch-cli/fastfetch/releases/download/${FASTFETCH_VERSION}/fastfetch-linux-amd64.deb" -O /tmp/fastfetch.deb
        sudo dpkg -i /tmp/fastfetch.deb
        rm /tmp/fastfetch.deb
    fi

    echo "âœ“ Debian/Ubuntu packages installed"
}

install_macos() {
    echo "ðŸ“¦ Installing packages for macOS..."

    if ! command -v brew &> /dev/null; then
        echo "âš  Homebrew not found!"
        echo "Install from: https://brew.sh"
        echo "Then run: chezmoi apply"
        exit 1
    fi

    local packages=(
        fzf zoxide starship ripgrep fd bat eza dust duf procs sd
        yazi tree gdu btop htop bottom bandwhich lazygit lazydocker git-delta
        micro tldr p7zip ffmpeg imagemagick poppler jq curl wget httpie
        gh tokei hyperfine rsync fastfetch glow
    )

    echo "Installing packages..."
    brew install "${packages[@]}"

    echo ""
    echo "Note: bluetui may need: cargo install bluetui"

    echo "âœ“ macOS packages installed"
}

# Install based on detected OS
case "$OS_TYPE" in
    arch)
        install_arch
        ;;
    fedora)
        install_fedora
        ;;
    debian)
        install_debian
        ;;
    macos)
        install_macos
        ;;
    *)
        echo "âŒ Unsupported OS"
        exit 1
        ;;
esac

echo ""
echo "ðŸŽ‰ CLI & TUI tools installation complete!"
echo ""
echo "ðŸ“Š Installation Summary:"
 # Comprehensive tool verification with versions and paths
    verify_tool() {
        local tool=$1
        local display_name=${2:-$tool}
        if command -v $tool &>/dev/null; then
            local path=$(command -v $tool)
            local version=""
            case $tool in
                fzf) version=$($tool --version 2>/dev/null | head -1) ;;
                zoxide) version=$($tool --version 2>/dev/null) ;;
                starship) version=$($tool --version 2>/dev/null | cut -d' ' -f2) ;;
                micro) version=$($tool --version 2>/dev/null | grep -oP 'Version: \K.*') ;;
                yazi) version=$($tool --version 2>/dev/null | head -1) ;;
                lazygit) version=$($tool --version 2>/dev/null | grep -oP 'version=\K[^,]+') ;;
                lazydocker) version=$($tool --version 2>/dev/null) ;;
                btop|btm) version=$($tool --version 2>/dev/null | head -1) ;;
                bat|batcat) version=$($tool --version 2>/dev/null | head -1) ;;
                rg) version=$($tool --version 2>/dev/null | head -1) ;;
                eza) version=$($tool --version 2>/dev/null | head -1) ;;
                delta) version=$($tool --version 2>/dev/null | head -1) ;;
                dust) version=$($tool --version 2>/dev/null) ;;
                gdu) version=$($tool --version 2>/dev/null) ;;
                gh) version=$($tool --version 2>/dev/null | head -1) ;;
                procs) version=$($tool --version 2>/dev/null) ;;
                sd) version=$($tool --version 2>/dev/null) ;;
                tokei) version=$($tool --version 2>/dev/null | head -1) ;;
                duf) version=$($tool --version 2>/dev/null | head -1) ;;
                bandwhich) version=$($tool --version 2>/dev/null) ;;
            esac
            echo "  âœ“ $display_name - v$version ($path)"
        else
            echo "  âœ— $display_name - NOT FOUND"
        fi
    }
    
    verify_tool fzf "fzf"
    verify_tool zoxide "zoxide"
    verify_tool starship "starship"
    verify_tool micro "micro"
    verify_tool yazi "yazi"
    verify_tool lazygit "lazygit"
    verify_tool lazydocker "lazydocker"
    verify_tool btop "btop"
    verify_tool btm "bottom"
    verify_tool bat "bat"
    verify_tool rg "ripgrep"
    verify_tool eza "eza"
    verify_tool delta "git-delta"
    verify_tool dust "dust"
    verify_tool gdu "gdu"
    verify_tool gh "GitHub CLI"
    verify_tool procs "procs"
    verify_tool sd "sd"
    verify_tool tokei "tokei"
    verify_tool duf "duf"
    verify_tool bandwhich "bandwhich"
echo ""
echo "Recommended next steps:"
echo "  - Restart your shell to activate new PATH entries"
echo "  - Configure starship: starship preset nerd-font-symbols -o ~/.config/starship.toml"
echo "  - Test yazi: yazi"
echo "  - Test lazygit: lazygit"
echo "  - Test micro: micro"

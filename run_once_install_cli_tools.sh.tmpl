#!/bin/bash
{{- $role := index . "role" | default "desktop" }}

# Install CLI tools and TUIs on all machines
set -euo pipefail

# Handle sudo when running as root
sudo() {
    if [ "$EUID" -eq 0 ]; then
        "$@"
    else
        command sudo "$@"
    fi
}

echo "=== Installing CLI & TUI Tools ==="
echo "Role: {{ $role }}"
echo "OS: $(uname -s)"
echo ""

# Detect OS and package manager
detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [[ -f /etc/arch-release ]]; then
        echo "arch"
    elif [[ -f /etc/fedora-release ]]; then
        echo "fedora"
    elif [[ -f /etc/debian_version ]]; then
        echo "debian"
    else
        echo "unknown"
    fi
}

OS_TYPE=$(detect_os)

ensure_rust_and_cargo() {
    if command -v cargo &> /dev/null; then
        echo "cargo already installed"
        return
    fi

    echo ""
    echo "Installing Rust toolchain (rustup + cargo)..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

    # Source the cargo env for this script
    export PATH="$HOME/.cargo/bin:$PATH"

    # Add to shell configs if not already present
    for rc_file in "$HOME/.bashrc" "$HOME/.zshrc"; do
        if [[ -f "$rc_file" ]] && ! grep -q 'cargo/env' "$rc_file"; then
            echo "" >> "$rc_file"
            echo '# Rust cargo path' >> "$rc_file"
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$rc_file"
            echo "  âœ“ Added cargo to PATH in $(basename $rc_file)"
        fi
    done

    if ! command -v cargo &> /dev/null; then
        echo "âŒ Failed to install cargo (Rust toolchain)"
        return 1
    fi

    echo "âœ“ Rust toolchain installed"
}

cargo_install_if_missing() {
    local crate="$1"
    local bin_name="${2:-$1}"

    if command -v "$bin_name" &> /dev/null; then
        echo "  - $bin_name already installed, skipping"
        return
    fi

    echo "  - Installing $bin_name via cargo ($crate)..."
    if cargo install "$crate" &> /dev/null; then
        echo "    âœ“ $bin_name installed"
    else
        echo "    âš  Failed to install $bin_name"
    fi
}

install_fresh_editor() {
    if command -v fresh &> /dev/null; then
        echo "  - fresh-editor already installed, skipping"
        return
    fi

    echo "  - Installing fresh-editor via cargo..."
    if cargo install fresh-editor; then
        echo "    âœ“ fresh-editor installed"
    else
        echo "    âš  Failed to install fresh-editor"
    fi
}

# Installs the latest stable version of micro via the official upstream binary script
install_micro_binary() {
    local existing_micro=""
    if command -v micro &> /dev/null; then
        existing_micro=$(which micro)
        local micro_version=$(micro --version 2>/dev/null | head -n1)
        echo "  - Found existing micro at: $existing_micro"
        echo "    Version: $micro_version"

        # Remove package if it's the broken 2.0.15-dev build
        if [[ "$micro_version" == *"2.0.15-dev"* ]]; then
            echo "    Detected broken 2.0.15-dev build, removing..."
            
            if command -v pacman &>/dev/null && pacman -Q micro &>/dev/null; then
                sudo pacman -R --noconfirm micro
            elif command -v apt &>/dev/null && dpkg -l | grep -q "^ii.*micro"; then
                sudo apt remove -y micro
            elif command -v dnf &>/dev/null && rpm -q micro &>/dev/null; then
                sudo dnf remove -y micro
            elif [[ -f "$existing_micro" ]]; then
                echo "    Removing $existing_micro manually..."
                sudo rm -f "$existing_micro"
            fi
        fi
    fi

    echo "  - Installing/updating micro via official binary script..."
    if curl -sL https://install.micro.mu | sudo bash; then
        echo "    âœ“ micro installed successfully"
        
        # Verify installation
        if ! command -v micro &> /dev/null; then
            echo "    âŒ micro not found in PATH after installation"
            return 1
        fi
        
        # Show version
        echo "    Version: $(micro --version 2>/dev/null | head -n1)"

        # Quick speed test (should be < 3 seconds)
        local start=$(date +%s%3N)
        timeout 5s micro --version &>/dev/null
        local duration=$(($(date +%s%3N) - start))

        if [[ $duration -gt 3000 ]]; then
            echo "    âš  Warning: micro seems slow (${duration}ms startup)"
        else
            echo "    âœ“ micro is responsive (${duration}ms startup)"
        fi
    else
        echo "    âš  Failed to install micro via binary script"
        return 1
    fi
}

setup_truecolor_terminfo() {
    echo ""
    echo "Setting up truecolor terminfo support..."

    # Check if xterm-direct already has RGB
    if infocmp -x xterm-direct 2>/dev/null | grep -q "RGB"; then
        echo "  - RGB terminfo already configured"
        return
    fi

    # Create user terminfo directory
    mkdir -p "$HOME/.terminfo"

    # Extract and add RGB capability
    if command -v infocmp &>/dev/null && command -v tic &>/dev/null; then
        echo "  - Adding RGB capability to xterm-direct terminfo..."
        infocmp xterm-direct > /tmp/xterm-direct.src 2>/dev/null || {
            echo "    âš  xterm-direct not found in system terminfo"
            return 1
        }

        # Add RGB to capabilities line (line 3)
        sed -i '3s/am,/am, RGB,/' /tmp/xterm-direct.src

        # Compile to user terminfo
        tic -x /tmp/xterm-direct.src -o "$HOME/.terminfo"

        # Add TERMINFO export to shell configs
        for rc_file in "$HOME/.bashrc" "$HOME/.zshrc"; do
            if [[ -f "$rc_file" ]] && ! grep -q 'TERMINFO=' "$rc_file"; then
                echo "" >> "$rc_file"
                echo '# User terminfo for truecolor support' >> "$rc_file"
                echo 'export TERMINFO=~/.terminfo' >> "$rc_file"
            fi
        done

        echo "    âœ“ RGB terminfo configured"
        rm -f /tmp/xterm-direct.src
    else
        echo "    âš  infocmp/tic not available, skipping terminfo setup"
    fi
}

install_arch() {
    echo "ðŸ“¦ Installing packages for Arch Linux..."

    # Core packages (official repos)
    local core_packages=(
        # Shell enhancements
        fzf zoxide starship

        # Modern CLI replacements
        ripgrep fd bat eza dust duf procs sd

        # File management & navigation
        yazi tree gdu

        # System monitoring
        btop htop bottom nethogs bandwhich

        # Git tools
        lazygit git-delta

        # Text tools
        tldr # Note: 'micro' removed for binary install

        # Archive & media tools (for yazi previews & general use)
        p7zip ffmpeg imagemagick poppler jq

        # Network tools
        curl wget httpie

        # Dev tools
        github-cli tokei hyperfine pyright bash-language-server

        # System utilities
        rsync unzip zip

        # Optional but useful
        fastfetch glow
    )

    echo "Installing core packages..."
    sudo pacman -S --needed --noconfirm "${core_packages[@]}" || {
        echo "âš  Some packages failed to install"
        echo "Continuing with remaining setup..."
    }

    # Install micro via the official binary script
    install_micro_binary

    # AUR packages (require yay or paru)
    local aur_packages=(
        lazydocker
        bluetui
    )

    # Optional AUR packages (may have dependency issues)
    local optional_aur=(
        ueberzugpp
    )

    if command -v yay &> /dev/null; then
        echo ""
        echo "Installing AUR packages via yay..."
        yay -S --needed --noconfirm "${aur_packages[@]}" 2>/dev/null || {
            echo "âš  Some AUR packages failed, continuing..."
        }

        echo ""
        echo "Attempting optional packages..."
        for pkg in "${optional_aur[@]}"; do
            echo "  Trying: $pkg"
            yay -S --needed --noconfirm "$pkg" 2>/dev/null && {
                echo "  âœ“ $pkg installed"
            } || {
                echo "  âš  $pkg skipped (dependency conflicts or unavailable)"
            }
        done

    elif command -v paru &> /dev/null; then
        echo ""
        echo "Installing AUR packages via paru..."
        paru -S --needed --noconfirm "${aur_packages[@]}" 2>/dev/null || {
            echo "âš  Some AUR packages failed, continuing..."
        }

        echo ""
        echo "Attempting optional packages..."
        for pkg in "${optional_aur[@]}"; do
            echo "  Trying: $pkg"
            paru -S --needed --noconfirm "$pkg" 2>/dev/null && {
                echo "  âœ“ $pkg installed"
            } || {
                echo "  âš  $pkg skipped (dependency conflicts or unavailable)"
            }
        done
    else
        echo "âš  No AUR helper (yay/paru) found"
        echo "  Required: ${aur_packages[*]}"
        echo "  Optional: ${optional_aur[*]}"
    fi

    ensure_rust_and_cargo
    install_fresh_editor
    setup_truecolor_terminfo

    echo "âœ“ Arch packages installed"
}

install_fedora() {
    echo "ðŸ“¦ Installing packages for Fedora..."

    local packages=(
        fzf zoxide starship ripgrep fd-find bat eza dust duf procs sd
        tree btop htop nethogs bandwhich git-delta tldr
        p7zip ffmpeg ImageMagick poppler-utils jq curl wget httpie
        gh tokei hyperfine rsync unzip zip glow
    )

    echo "Installing packages..."
    sudo dnf install -y "${packages[@]}"

    # Install micro via the official binary script
    install_micro_binary
    
    # Setup truecolor support
    setup_truecolor_terminfo

    echo ""
    echo "Note: Some tools need manual installation on Fedora:"
    echo "  - lazygit: https://github.com/jesseduffield/lazygit"
    echo "  - lazydocker: https://github.com/jesseduffield/lazydocker"
    echo "  - yazi: cargo install --locked yazi-fm"
    echo "  - bluetui: cargo install bluetui"
    echo "  - bottom: cargo install bottom"
    echo "  - dog: cargo install dog"
    echo "  - gdu: https://github.com/dundee/gdu/releases"

    echo "âœ“ Fedora packages installed"
}

install_debian() {
    echo "ðŸ“¦ Installing packages for Debian/Ubuntu/ChromeOS Linux..."

    sudo apt update

    local packages=(
        # Shell / navigation
        fzf zoxide

        # Modern CLI replacements
        ripgrep fd-find bat tree ncdu eza

        # System monitoring
        btop htop nethogs

        # Archive & media tools (for previews & general use)
        p7zip-full ffmpeg imagemagick poppler-utils jq

        # Network / HTTP tools
        curl wget httpie

        # Git / VCS helpers
        lazygit

        # System utilities
        rsync unzip zip
    )

    echo "Installing packages via apt..."
    sudo apt install -y "${packages[@]}"

    # Install micro via the official binary script
    install_micro_binary
    
    # Setup truecolor support
    setup_truecolor_terminfo

    echo ""
    echo "Ensuring Rust + cargo are available for Rust-based CLIs..."
    if ensure_rust_and_cargo; then
        echo ""
        echo "Installing Rust-based CLIs via cargo..."
        # Ensure cargo is on PATH in case rustup just ran
        export PATH="$HOME/.cargo/bin:$PATH"

        # Core Rust tools (all roles)
        cargo_install_if_missing du-dust dust          # dust
        cargo_install_if_missing procs procs           # procs
        cargo_install_if_missing sd sd                 # sd
        cargo_install_if_missing yazi-fm yazi          # yazi
        cargo_install_if_missing git-delta delta       # git delta
        cargo_install_if_missing tokei tokei           # tokei
        cargo_install_if_missing hyperfine hyperfine   # hyperfine
        cargo_install_if_missing bottom btm            # bottom
        cargo_install_if_missing bandwhich bandwhich   # bandwhich

        # Extra Rust tools only for desktop / laptop roles
        {{- if or (eq $role "desktop") (eq $role "laptop") }}
        cargo_install_if_missing dog dog               # dog (DNS client)
        cargo_install_if_missing bluetui bluetui       # Bluetui (BT TUI)
        {{- end }}

        # gdu is Go-based, not Rust, so we leave it to manual/binary install:
        echo "  - gdu: install from https://github.com/dundee/gdu/releases if desired"
    else
        echo "âš  Skipping cargo-based tools (Rust toolchain not available)"
    fi

    # Install lazydocker via official script on Debian/Ubuntu
    if ! command -v lazydocker &> /dev/null; then
        echo ""
        echo "Installing lazydocker via upstream script..."
        if DIR="/usr/local/bin" \
          curl -fsSL https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh \
          | bash; then
            echo "  âœ“ lazydocker installed"
        else
            echo "  âš  Failed to install lazydocker via script"
        fi
    else
        echo "  - lazydocker already installed, skipping"
    fi

    if ! command -v starship &> /dev/null; then
        echo ""
        echo "Installing starship prompt..."
        curl -sS https://starship.rs/install.sh | sh -s -- -y
    fi

    echo "âœ“ Debian packages installed"
}

install_macos() {
    echo "ðŸ“¦ Installing packages for macOS..."

    if ! command -v brew &> /dev/null; then
        echo "âš  Homebrew not found!"
        echo "Install from: https://brew.sh"
        echo "Then run: chezmoi apply"
        exit 1
    fi

    local packages=(
        fzf zoxide starship ripgrep fd bat eza dust duf procs sd
        yazi tree gdu btop htop bottom bandwhich lazygit lazydocker git-delta
        micro tldr p7zip ffmpeg imagemagick poppler jq curl wget httpie
        gh tokei hyperfine rsync fastfetch glow
    )

    echo "Installing packages..."
    brew install "${packages[@]}"

    echo ""
    echo "Note: bluetui may need: cargo install bluetui"

    echo "âœ“ macOS packages installed"
}

# Install based on detected OS
case "$OS_TYPE" in
    arch)
        install_arch
        ;;
    fedora)
        install_fedora
        ;;
    debian)
        install_debian
        ;;
    macos)
        install_macos
        ;;
    *)
        echo "âŒ Unsupported OS"
        exit 1
        ;;
esac

echo ""
echo "ðŸŽ‰ CLI & TUI tools installation complete!"
echo ""
echo "ðŸ“Š Installation Summary:"
command -v fzf &>/dev/null && echo "  âœ“ fzf"
command -v zoxide &>/dev/null && echo "  âœ“ zoxide"
command -v starship &>/dev/null && echo "  âœ“ starship"
command -v micro &>/dev/null && echo "  âœ“ micro ($(micro --version 2>/dev/null | head -n1))"
command -v yazi &>/dev/null && echo "  âœ“ yazi"
command -v lazygit &>/dev/null && echo "  âœ“ lazygit"
command -v lazydocker &>/dev/null && echo "  âœ“ lazydocker"
command -v btop &>/dev/null && echo "  âœ“ btop"
command -v bat &>/dev/null && echo "  âœ“ bat"
command -v ripgrep &>/dev/null && echo "  âœ“ ripgrep"
echo ""
echo "Recommended next steps:"
echo "  - Restart your shell to activate new PATH entries"
echo "  - Configure starship: starship preset nerd-font-symbols -o ~/.config/starship.toml"
echo "  - Test yazi: yazi"
echo "  - Test lazygit: lazygit"
echo "  - Test micro: micro"

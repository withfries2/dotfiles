#!/bin/bash
set -euo pipefail

{{ $osid := .osid -}}
{{ $role := .role -}}

echo "=== üöÄ Starting System Provisioning ==="

# -----------------------------------------------------------------------------
# 1. HELPER FUNCTIONS
# -----------------------------------------------------------------------------
get_latest_github_url() {
    local repo=$1
    local pattern=$2
    # The '|| echo ""' prevents grep failure from triggering set -e
    curl -s "https://api.github.com/repos/$repo/releases/latest" | \
    grep "browser_download_url" | \
    grep -iE "$pattern" | \
    cut -d '"' -f 4 | head -n 1 || echo ""
}

# -----------------------------------------------------------------------------
# 2. NATIVE PACKAGES & FIXES
# -----------------------------------------------------------------------------
# ... (Keep your existing Section 2 logic for apt/pacman and bat/fd links) ...

# -----------------------------------------------------------------------------
# 3. GUI APPLICATIONS
# -----------------------------------------------------------------------------
# ... (Keep your existing Section 3 logic for chrome/ghostty/zen) ...

# -----------------------------------------------------------------------------
# 4. STANDALONE BINARY TOOLS
# -----------------------------------------------------------------------------
echo "Installing standalone CLI binaries..."
{{ range .binaries -}}
if ! command -v {{ .name }} &> /dev/null; then
    echo "üîç Searching for {{ .name }}..."
    
    # Use pattern from data if it exists, otherwise use a generic fallback
    {{ if hasKey . "pattern" -}}
    URL=$(get_latest_github_url "{{ .repo }}" "{{ .pattern }}")
    {{ else -}}
    URL=$(get_latest_github_url "{{ .repo }}" "linux.*(amd64|x86_64).*tar\\.gz")
    {{ end -}}
    
    if [ -n "$URL" ]; then
        echo "   ‚¨áÔ∏è Fetching {{ .name }}..."
        curl -L "$URL" -o /tmp/{{ .name }}.archive
        mkdir -p /tmp/{{ .name }}-unpack
        
        # Robust extraction
        if [[ "$URL" == *.zip ]]; then
            unzip -q /tmp/{{ .name }}.archive -d /tmp/{{ .name }}-unpack || true
        else
            tar -xf /tmp/{{ .name }}.archive -C /tmp/{{ .name }}-unpack 2>/dev/null || true
        fi

        # Find and move binary
        BINARY_PATH=$(find /tmp/{{ .name }}-unpack -type f -name "{{ .name }}" | head -n 1)
        if [ -n "$BINARY_PATH" ]; then
            mv "$BINARY_PATH" ~/.local/bin/{{ .name }}
            chmod +x ~/.local/bin/{{ .name }}
            echo "   ‚úÖ {{ .name }} installed."
        fi
        rm -rf /tmp/{{ .name }}.archive /tmp/{{ .name }}-unpack
    else
        echo "   ‚ö†Ô∏è Warning: Asset not found for {{ .name }}. Skipping..."
    fi
fi
{{ end -}}

echo "=== ‚úÖ Provisioning Complete! ==="
